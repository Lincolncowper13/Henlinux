name: HenLinux VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-henlinux-vps:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Required Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            binfmt-support qemu qemu-user-static debootstrap systemd-container

      - name: Create Base HenLinux Image
        run: |
          mkdir -p henlinux-image
          sudo debootstrap --no-merged-usr --exclude=systemd --arch=amd64 bullseye henlinux-image http://deb.debian.org/debian

      - name: Fix Package Configuration in Chroot
        run: |
          sudo chroot henlinux-image /bin/bash -c "
          apt-get update
          apt-get install -f -y
          dpkg --configure -a || true
          apt-get install systemd -y || true
          "

      - name: Force Install Systemd and Dependencies
        run: |
          sudo chroot henlinux-image /bin/bash -c "
          apt-get update
          dpkg --force-depends --install /var/cache/apt/archives/*.deb || true
          apt-get install -f -y
          "

      - name: Check Debootstrap Logs
        if: failure()
        run: |
          cat henlinux-image/debootstrap/debootstrap.log

      - name: Install and Configure OpenSSH with Root Access
        run: |
          sudo chroot henlinux-image /bin/bash -c "
          apt-get update && apt-get install -y openssh-server
          mkdir -p /var/run/sshd
          echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config
          echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config
          echo 'root:Henlinux13' | chpasswd
          systemctl enable ssh
          "

      - name: Install and Configure Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          sudo chroot henlinux-image /bin/bash -c "
          apt-get update && apt-get install -y curl gnupg
          curl -fsSL https://tailscale.com/install.sh | sh
          tailscaled &
          tailscale up --auth-key ${TAILSCALE_AUTHKEY}
          tailscale ip -4 > /tmp/ip_henlinux.txt
          "

      - name: Display Login Credentials and Keep Active
        run: |
          sudo chroot henlinux-image /bin/bash -c "cat /tmp/ip_henlinux.txt" > ip_henlinux.txt
          echo "========================================="
          echo "HenLinux VPS Details:"
          echo "Root Username: root"
          echo "Root Password: Henlinux13"
          echo "IP HenLinux: $(cat ip_henlinux.txt)"
          echo "========================================="
          echo "HenLinux Active"
          while :; do sleep 60; done

      - name: Clean Up Image
        run: |
          sudo chroot henlinux-image /bin/bash -c "
          apt-get clean
          rm -rf /var/lib/apt/lists/*
          "

      - name: Package HenLinux Image
        run: |
          sudo tar -czvf henlinux-image.tar.gz -C henlinux-image .

      - name: Upload HenLinux Image
        uses: actions/upload-artifact@v3
        with:
          name: henlinux-vps
          path: henlinux-image.tar.gz
