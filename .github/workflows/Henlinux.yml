name: HenLinux VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-henlinux-vps:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io

      - name: Build Docker Image for HenLinux
        run: |
          docker build -t henlinux-vps .

      - name: Run HenLinux Container and Set Up
        run: |
          docker run --name henlinux-container -d henlinux-vps
          docker exec henlinux-container bash -c "echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config"
          docker exec henlinux-container bash -c "echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config"
          docker exec henlinux-container bash -c "echo 'root:Henlinux13' | chpasswd"
          docker exec henlinux-container bash -c "service ssh start"
          docker exec henlinux-container bash -c "tailscale up --auth-key ${TAILSCALE_AUTHKEY}"
          
      - name: Get HenLinux VPS IP Address
        run: |
          docker exec henlinux-container bash -c "tailscale ip -4" > ip_henlinux.txt
          echo "========================================="
          echo "HenLinux VPS Details:"
          echo "Root Username: root"
          echo "Root Password: Henlinux13"
          echo "IP HenLinux: $(cat ip_henlinux.txt)"
          echo "========================================="
          
      - name: Keep HenLinux VPS Running
        run: |
          while :; do sleep 60; done
          
      - name: Clean Up Docker Image
        run: |
          docker stop henlinux-container
          docker rm henlinux-container
          
      - name: Upload HenLinux Image
        uses: actions/upload-artifact@v3
        with:
          name: henlinux-vps
          path: ./henlinux-image.tar.gz
