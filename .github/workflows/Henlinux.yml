name: HenLinux VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-henlinux-vps:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Docker and Remove Conflicting Packages
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io
          sudo apt-get remove -y containerd
          sudo apt-get autoremove -y

      - name: Install containerd.io
        run: |
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y containerd.io

      - name: Build Docker Image for HenLinux
        run: |
          docker build -t henlinux-vps .

      - name: Run HenLinux Container and Set Up
        run: |
          docker run --name henlinux-container -d henlinux-vps
          docker exec henlinux-container bash -c "echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config"
          docker exec henlinux-container bash -c "echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config"
          docker exec henlinux-container bash -c "echo 'root:Henlinux13' | chpasswd"
          docker exec henlinux-container bash -c "service ssh start"
          docker exec henlinux-container bash -c "tailscale up --auth-key ${TAILSCALE_AUTHKEY}"
          
      - name: Get HenLinux VPS IP Address
        run: |
          docker exec henlinux-container bash -c "tailscale ip -4" > ip_henlinux.txt
          echo "========================================="
          echo "HenLinux VPS Details:"
          echo "Root Username: root"
          echo "Root Password: Henlinux13"
          echo "IP HenLinux: $(cat ip_henlinux.txt)"
          echo "========================================="
          
      - name: Keep HenLinux VPS Running
        run: |
          while :; do sleep 60; done
          
      - name: Clean Up Docker Image
        run: |
          docker stop henlinux-container
          docker rm henlinux-container
          
      - name: Upload HenLinux Image
        uses: actions/upload-artifact@v3
        with:
          name: henlinux-vps
          path: ./henlinux-image.tar.gz
